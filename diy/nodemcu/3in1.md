# 三合一气象站



B3套餐成品效果图

?>PIC




## 硬件准备


| ![](http://pic.airijia.com/doc/20190112174252.png ':size=200')| 整套购买(B系列套餐) |  [![买买买](http://cdn.airijia.com/b6eca8da724952cc0251.gif ':size=150')](https://item.taobao.com/item.htm?id=577014079869) | 
|:-:|:-:|:-:|
| ![](http://pic.airijia.com/doc/20190113113732.png ':size=200')| 0.96寸 OLED 屏幕+积木面板  |  [![买买买](http://cdn.airijia.com/b6eca8da724952cc0251.gif ':size=150')](https://item.taobao.com/item.htm?id=585830522424) |
| ![](http://pic.airijia.com/doc/20181205171519.png ':size=200')| NodeMCU CP2102 |  [![买买买](http://cdn.airijia.com/b6eca8da724952cc0251.gif ':size=150')](https://item.taobao.com/item.htm?id=585975819567) |
| ![](http://pic.airijia.com/doc/20190306094306.png ':size=200')| 三合一气象传感器模块 |  [![买买买](http://cdn.airijia.com/b6eca8da724952cc0251.gif ':size=150')](https://item.taobao.com/item.htm?id=585205682947) |
| ![](http://pic.airijia.com/doc/20181122162418.png ':size=200')| 杜邦线 母对母 |  [![买买买](http://cdn.airijia.com/b6eca8da724952cc0251.gif ':size=150')](https://item.taobao.com/item.htm?id=45608073136) |





**以下需自备**

- Micro USB 数据线 (安卓扁口)
- 带 USB 接口电脑，操作系统 **WIN 7 及以上** 或 **MAC OS**
- 绝缘胶带


## 刷 ESPHome 固件




## 进阶使用

**上传模板文件** 的方式创建 ESPHome 固件

### B1

需要用到 [I²C 总线](esphome/components/i2c) 等多个组件，具体见文末的[相关链接](#相关链接)

```yaml
substitutions:
  # 把这三项改成你自己的设置
  hostname: '666'
  ssid: 'airi'
  password: 'airijia.com'
esphome:
  name: $hostname
  platform: ESP8266
  board: nodemcuv2
wifi:
  ssid: $ssid
  password: $password
  fast_connect: True
api:
  reboot_timeout: 0s
ota:
logger:

i2c:
  sda: D2
  scl: D1
  scan: False
sensor:
  # HTU21D
  - platform: htu21d
    temperature:
      name: $hostname htu21d temperature
      id: htu21d_temperature
    humidity:
      name: $hostname humidity
      id: htu21d_humidity
    update_interval: 60s
  # BMP180
  - platform: bmp085
    temperature:
      name: $hostname bmp180 temperature
      id: bmp180_temperature
    pressure:
      name: $hostname pressure
      id: bmp180_pressure
    address: 0x77
    update_interval: 60s
  # BH1750
  - platform: bh1750
    name: $hostname illuminance
    address: 0x23
    resolution: 0.5
    update_interval: 60s
```


### B1增强

在B1的基础上增加了海拔高度和绝对湿度的换算

[完整模板文件下载](https://gitee.com/airijia/esphome-config/blob/master/NodeMCU8266/environmental/3in1.yaml)

这里只讲解与 [B1](#B1) 不同的部分

```yaml
globals:
  - id: sea
    # 海平面平均大气压 单位hPa
    type: float
    initial_value: '1013.25'
  - id: mw
    # 水的摩尔质量 单位g/mol
    type: float
    initial_value: '18.01534'
  - id: r
    # 通用气体常数 单位J/mol/K
    type: float
    initial_value: '8.31447215'
```

引入几个常数，计算用

```yaml
  - platform: template
    # 海拔高度
    name: $hostname Altitude
    lambda: >-
      return ((id(htu21d_temperature).state + 273.15) / 0.0065) * \
      (powf((id(sea) / id(bmp180_pressure).state), 0.190234) - 1); 
    update_interval: 15s
```

使用 HTU21D 的温度、BMP180 的大气压和海平面平均大气压计算出海拔高度，结果的单位为米(m)

?> `\` 是换行符，不要理会

powf(x,y)函数，计算浮点数 x 的 y 次幂


```yaml
  - platform: template
    # 绝对湿度
    name: $hostname Absolute Humidity
    lambda: >-
      return (6.112 * powf(2.718281828, (17.67 * id(htu21d_temperature).state) / \
        (id(htu21d_temperature).state + 243.5)) * id(htu21d_humidity).state * id(mw)) / \
        ((273.15 + id(htu21d_temperature).state) * id(r)); 
    update_interval: 15s
```

使用 HTU21D 的温度和湿度、水的摩尔质量、通用气体常数计算出绝对湿度，结果的单位为 g/m³


### B2

B2以上使用同样的方法

[完整模板文件下载](https://gitee.com/airijia/esphome-config/blob/master/NodeMCU8266/environmental/3in1+oled.yaml)




### B2增强

在 B23的基础上增加了彩云天气

[完整模板文件下载](https://gitee.com/airijia/esphome-config/blob/master/NodeMCU8266/environmental/3in1+oled+caiyun.yaml)




## 相关链接

- [I²C 总线](esphome/components/i2c)
- [HTU21D 温湿度传感器](esphome/components/sensor/htu21d)
- [BMP180 温度+气压传感器](esphome/components/sensor/bmp085)
- [BH1750 光强传感器](esphome/components/sensor/bh1750)
- [显示屏核心组件](esphome/components/display/) 
- [SSD1306 OLED I2C显示屏](esphome/components/display/ssd1306_i2c)
- [时间](esphome/components/time)




- [绝对湿度](https://baike.baidu.com/item/%E7%BB%9D%E5%AF%B9%E6%B9%BF%E5%BA%A6)
- [海平面平均大气压](https://baike.baidu.com/item/%E6%B5%B7%E5%B9%B3%E9%9D%A2%E6%B0%94%E5%8E%8B)
- [通用气体常数](https://baike.baidu.com/item/%E7%90%86%E6%83%B3%E6%B0%94%E4%BD%93%E5%B8%B8%E6%95%B0)
- [水的摩尔质量](https://baike.baidu.com/item/%E6%91%A9%E5%B0%94/22424)



- [感谢 Tyler Glenn 的公式 EnvironmentCalculations.cpp](https://github.com/finitespace/BME280/blob/master/src/EnvironmentCalculations.cpp)
- [绝对湿度转换为相对湿度](https://carnotcycle.wordpress.com/2012/08/04/how-to-convert-relative-humidity-to-absolute-humidity/)
- [大气压和海拔的换算](https://en.wikipedia.org/wiki/Atmospheric_pressure#Altitude_variation)


- [数学函数 pow, powf, powl](https://zh.cppreference.com/w/c/numeric/math/pow)